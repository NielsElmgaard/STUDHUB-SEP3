@namespace Client.Components.Dashboard

@using System.Security.Claims
@using Client.Components.ConnectionForms
@using Client.Services.StoreConnection
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using StudHub.SharedDTO.StoreCredentials

@inject IStoreAuthClientService StoreAuthClientService

<CascadingAuthenticationState>
    <div class="store-widget-root">

        <!-- Compact status rows ALWAYS visible -->
        <div class="d-flex flex-column gap-2 mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <span>BrickLink</span>
                <span class="badge @(brickLinkConnected ? "bg-success" : "bg-secondary")">
                    @(brickLinkConnected ? "connected" : "not connected")
                </span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <span>BrickOwl</span>
                <span class="badge @(brickOwlConnected ? "bg-success" : "bg-secondary")">
                    @(brickOwlConnected ? "connected" : "not connected")
                </span>
            </div>
        </div>

        <!-- Details ONLY when NOT collapsed -->
        @if (!IsCollapsed)
        {
            <div class="mt-3">
                <h6 class="store-connection-glow my-2">BrickLink</h6>
                @if (!string.IsNullOrEmpty(LastSubmitResultBL))
                {
                    <div class="alert @(isSuccesBL ? "alert-success" : "alert-danger") py-1 my-2">
                        @LastSubmitResultBL
                    </div>
                }

                <BrickLinkCredentialsForm BrickLinkCredentials="_brickLinkCredentials"
                                          OnValidSubmit="ValidBrickLinkFormSubmitted"
                                          OnInvalidSubmit="InvalidBrickLinkFormSubmitted"/>

                <h6 class="store-connection-glow mt-4 mb-2">BrickOwl</h6>
                @if (!string.IsNullOrEmpty(LastSubmitResultBO))
                {
                    <div class="alert @(isSuccesBO ? "alert-success" : "alert-danger") py-1 my-2">
                        @LastSubmitResultBO
                    </div>
                }

                <BrickOwlCredentialsForm BrickOwlCredentials="_brickOwlCredentials"
                                         OnValidSubmit="ValidBrickOwlFormSubmitted"
                                         OnInvalidSubmit="InvalidBrickOwlFormSubmitted"/>
            </div>
        }
    </div>
</CascadingAuthenticationState>


@code {
    // local UI state
    private bool brickLinkConnected;
    private bool brickOwlConnected;

    // same DTOs as your page
    private BrickLinkCredentialsRequestDTO _brickLinkCredentials = new();
    private BrickOwlCredentialsRequestDTO _brickOwlCredentials = new();

    private string? LastSubmitResultBL;
    private string? LastSubmitResultBO;
    private bool isSuccesBL;
    private bool isSuccesBO;

    private BrickLinkCredentialsResponseDTO? CreatedBrickLinkConnection;
    private BrickOwlCredentialsResponseDTO? CreatedBrickOwlConnection;

    [CascadingParameter] public Task<AuthenticationState> State { get; set; } = default!;
    [CascadingParameter] public bool IsCollapsed { get; set; }

    private async Task ValidBrickLinkFormSubmitted()
    {
        var authenticationState = await State;
        var claimsPrincipal = authenticationState.User;

        if (claimsPrincipal.Identity is null || !claimsPrincipal.Identity.IsAuthenticated)
        {
            LastSubmitResultBL = "You must be logged in to sync.";
            isSuccesBL = false;
            return;
        }

        var userIdClaim = claimsPrincipal.FindFirst(ClaimTypes.NameIdentifier);
        if (userIdClaim == null || !long.TryParse(userIdClaim.Value, out long studUserId))
        {
            LastSubmitResultBL = "Error: Could not retrieve or parse user ID.";
            isSuccesBL = false;
            return;
        }

        _brickLinkCredentials.StudUserId = studUserId;
        LastSubmitResultBL = "Connecting BrickLink...";
        isSuccesBL = false;

        try
        {
            CreatedBrickLinkConnection = await StoreAuthClientService.SetBrickLinkCredentials(_brickLinkCredentials);

            LastSubmitResultBL = "Success! BrickLink connected.";
            isSuccesBL = true;
            brickLinkConnected = true;
        }
        catch (Exception e)
        {
            LastSubmitResultBL = $"Server Error: {e.Message}";
            isSuccesBL = false;
        }
    }

    private void InvalidBrickLinkFormSubmitted()
    {
        isSuccesBL = false;
    }

    private async Task ValidBrickOwlFormSubmitted()
    {
        var authenticationState = await State;
        var claimsPrincipal = authenticationState.User;

        if (claimsPrincipal.Identity is null || !claimsPrincipal.Identity.IsAuthenticated)
        {
            LastSubmitResultBO = "You must be logged in to sync.";
            isSuccesBO = false;
            return;
        }

        var userIdClaim = claimsPrincipal.FindFirst(ClaimTypes.NameIdentifier);
        if (userIdClaim == null || !long.TryParse(userIdClaim.Value, out long studUserId))
        {
            LastSubmitResultBO = "Error: Could not retrieve or parse user ID.";
            isSuccesBO = false;
            return;
        }

        _brickOwlCredentials.StudUserId = studUserId;
        LastSubmitResultBO = "Connecting Brick Owl...";
        isSuccesBO = false;

        try
        {
            CreatedBrickOwlConnection = await StoreAuthClientService.SetBrickOwlCredentials(_brickOwlCredentials);

            LastSubmitResultBO = "Success! Brick Owl connected.";
            isSuccesBO = true;
            brickOwlConnected = true;
        }
        catch (Exception e)
        {
            LastSubmitResultBO = $"Server Error: {e.Message}";
            isSuccesBO = false;
        }
    }

    private void InvalidBrickOwlFormSubmitted()
    {
        isSuccesBO = false;
    }
}
