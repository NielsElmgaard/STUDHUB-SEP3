@page "/DisplayBrickLinkIdentifiersTest"
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject IInventoryClientService InventoryClientService

<AuthorizeView>
    <Authorized>
        <p role="status">@errorMessage</p>
        @if (isLoading)
        {
            <div class="d-flex justify-content-center my-3">
                <img src="spinner.gif" alt="Loading..."
                     class="img-fluid w-25 mx-auto d-block"/>
            </div>
        }
        else if (Identifiers.Count == 0)
        {
            <p>No Identifiers found.</p>
        }
        else
        {
            <h3>BrickLink Inventory Identifiers (Keys) Found:</h3>
            <pre style="background-color: #282c34; color: #98c379; padding: 15px; border: 1px solid #61afef;">
                @foreach (var identifier in Identifiers)
                {
                    @identifier
                    <br/>
                }
            </pre>
            <p class="mt-3">
                <small>Total Unique Keys: <strong>@Identifiers.Count</strong></small>
            </p>
        }
    </Authorized>
    <NotAuthorized>
        <NotAuthorizedContent/>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<string> Identifiers { get; set; } = new();
    private bool isLoading = true;
    
    [CascadingParameter] public Task<AuthenticationState> State { get; set; }

    private string? errorMessage;
    protected override async Task OnInitializedAsync()
    {
        AuthenticationState authenticationState = await State;
        ClaimsPrincipal claimsPrincipal = authenticationState.User;


        if (claimsPrincipal.Identity is null || !claimsPrincipal.Identity.IsAuthenticated)
        {
            // the user is not logged in
            isLoading = false;
            return;
        }

        var username = claimsPrincipal.FindFirst(ClaimTypes.Name)?.Value;
        var studUserIdClaim = claimsPrincipal.FindFirst(ClaimTypes.NameIdentifier);
        if (studUserIdClaim == null || !long.TryParse(studUserIdClaim.Value, out var studUserId))
        {
            errorMessage = "Could not fetch stud ID.";
            isLoading = false;
            return;
        }

        isLoading = true;
        try
        {
            Identifiers = await InventoryClientService.DiscoverBrickLinkInventoryKeysAsync(studUserId);
        }
        catch (Exception e)
        {
            if (e.Message.Contains($"No BrickLink credentials for"))
            {
                errorMessage = $"No BrickLink credentials for: {username}. Please link your account";
                Identifiers = new List<string>();
            }
            else
            {
                errorMessage = $"An error occurred while fetching inventories: {e.Message}";
            }
        }
        finally
        {
            isLoading = false;
        }
    }
}