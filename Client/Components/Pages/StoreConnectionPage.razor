@page "/StoreConnectionPage"
@using System.Security.Claims
@using Client.Components.Forms
@using Client.Services.StoreConnection
@using Microsoft.AspNetCore.Components.Authorization
@using Studhub.AppServer.Services.Auth_Login
@using StudHub.SharedDTO
@using StudHub.SharedDTO.StoreCredentials

@inject AuthenticationStateProvider AuthStateProvider
@inject IStoreAuthClientService StoreAuthClientService

<PageTitle>Store Connection</PageTitle>

<AuthorizeView>
    <Authorized>
        <!-- MATCH DASHBOARD HEADER -->
        <div class="dashboard-header">
            <div class="dashboard-header-left">
                <h3 class="mb-1 page-title-glow">store connection</h3>
                <small class="logged-in-info">logged in as @userEmail</small>
            </div>

            <div class="dashboard-header-right">
                <!-- reserved for notifications -->
            </div>
        </div>

        <!-- PAGE BODY -->
        <div class="store-page">
            <!-- BrickLink -->
            <section class="store-section">
                <h4 class="store-connection-glow mb-2">BrickLink</h4>

                @if (!string.IsNullOrEmpty(LastSubmitResultBL))
                {
                    <div
                        class="alert @(isSuccesBL ? "alert-success" : "alert-danger") store-alert">
                        @LastSubmitResultBL
                    </div>
                }

                @if (IsDataServiceDownBL)
                {
                    <div class="alert alert-danger store-alert">
                        Cannot connect to the <b>data service</b>. Please try again
                        later.
                    </div>
                }

                else if (!(IsBrickLinkConnected?.IsConnected ?? false))
                {
                    <p class="store-body-text">Steps to obtain BrickLink
                        credentials:</p>
                    <ul class="store-body-list">
                        <li>
                            Visit
                            <a href="https://www.bricklink.com/v2/api/register_consumer.page"
                               target="_blank" rel="noopener noreferrer">BrickLink</a>
                        </li>
                        <li>Add access token</li>
                        <li>We advise using 0.0.0.0 for IP Address + Mask</li>
                    </ul>

                    <BrickLinkCredentialsForm
                        BrickLinkCredentials="_brickLinkCredentials"
                        OnValidSubmit="ValidBrickLinkFormSubmitted"
                        OnInvalidSubmit="InvalidBrickLinkFormSubmitted"/>
                }
                else
                {
                    <div>
                        <div class="alert alert-success store-alert">BrickLink
                            is connected.
                        </div>
                        <PopUpConfirm Title="Disconnect"
                                      Class="btn btn-logout-neon w-25"
                                      Message="Are you sure you want to disconnect BrickLink?"
                                      YesCssClass="btn-yes"
                                      NoCssClass="btn-no"
                                      ConfirmedChanged="((confirmed) => ConfirmDisconnectBrickLink(confirmed))">
                            <MessageTemplate>
                                <div class="card pop-message-card">
                                    <div class="card-header">
                                        Disconnect BrickLink?
                                    </div>
                                    <div class="card-body">
                                        <p>
                                            This will disconnect the BrickLink
                                            connection<br/>
                                            Are you sure?
                                        </p>
                                    </div>
                                </div>
                            </MessageTemplate>
                        </PopUpConfirm>
                    </div>
                }
            </section>


            <!-- BrickOwl -->
            <section class="store-section mt-5">
                <h4 class="store-connection-glow mb-2">BrickOwl</h4>

                @if (!string.IsNullOrEmpty(LastSubmitResultBO))
                {
                    <div
                        class="alert @(isSuccesBO ? "alert-success" : "alert-danger") store-alert">
                        @LastSubmitResultBO
                    </div>
                }

                @if (IsDataServiceDownBO)
                {
                    <div class="alert alert-danger store-alert">
                        Cannot connect to the <b>data service</b>. Please try again
                        later.
                    </div>
                }
                else if (!(IsBrickOwlConnected?.IsConnected ?? false))
                {
                    <p class="store-body-text">Steps to obtain BrickOwl
                        credentials:</p>
                    <ul class="store-body-list">
                        <li>
                            Visit
                            <a href="https://www.brickowl.com/api_docs"
                               target="_blank" rel="noopener noreferrer">Brick
                                Owl</a>
                        </li>
                        <li>Generate API key</li>
                        <li>Add the API Key</li>
                        <li>Ensure the key is enabled</li>
                    </ul>

                    <BrickOwlCredentialsForm
                        BrickOwlCredentials="_brickOwlCredentials"
                        OnValidSubmit="ValidBrickOwlFormSubmitted"
                        OnInvalidSubmit="InvalidBrickOwlFormSubmitted"/>
                }
                else
                {
                    <div>
                        <div class="alert alert-success store-alert">BrickOwl is
                            connected.
                        </div>
                        <PopUpConfirm Title="Disconnect"
                                      Class="btn btn-logout-neon w-25"
                                      Message="Are you sure you want to disconnect Brick Owl?"
                                      YesCssClass="btn-yes"
                                      NoCssClass="btn-no"
                                      ConfirmedChanged="((confirmed) => ConfirmDisconnectBrickOwl(confirmed))">
                            <MessageTemplate>
                                <div class="card pop-message-card">
                                    <div class="card-header">
                                        Disconnect Brick Owl?
                                    </div>
                                    <div class="card-body">
                                        <p>
                                            This will disconnect the Brick Owl
                                            connection<br/>
                                            Are you sure?
                                        </p>
                                    </div>
                                </div>
                            </MessageTemplate>
                        </PopUpConfirm>
                    </div>
                }
            </section>
        </div>

    </Authorized>

    <NotAuthorized>
        <NotAuthorizedContent/>
    </NotAuthorized>
</AuthorizeView>


@code {
    private BrickLinkCredentialsRequestDTO _brickLinkCredentials = new();
    private BrickOwlCredentialsRequestDTO _brickOwlCredentials = new();

    private string? LastSubmitResultBL;
    private string? LastSubmitResultBO;

    private bool isSuccesBL;
    private bool isSuccesBO;

    private ConnectionStatusDTO? IsBrickLinkConnected { get; set; }
    private ConnectionStatusDTO? IsBrickOwlConnected { get; set; }

    private string? userEmail;

    [CascadingParameter] public Task<AuthenticationState> State { get; set; } = default!;

    private bool IsDataServiceDownBL =>
        IsBrickLinkConnected?.ErrorMessage?.Contains("gRPC Error") ?? false;

    private bool IsDataServiceDownBO =>
        IsBrickOwlConnected?.ErrorMessage?.Contains("gRPC Error") ?? false;

    protected override async Task OnInitializedAsync()
    {
        // Get logged-in email for header
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated ?? false)
            userEmail = user.Identity.Name;

        // Load connection statuses
        AuthenticationState authenticationState = await State;
        ClaimsPrincipal cp = authenticationState.User;

        var uid = cp.FindFirst(ClaimTypes.NameIdentifier);
        if (uid != null && long.TryParse(uid.Value, out long studUserId))
        {
            try
            {
                IsBrickLinkConnected = await StoreAuthClientService.IsBrickLinkConnected(studUserId);
                IsBrickOwlConnected = await StoreAuthClientService.IsBrickOwlConnected(studUserId);
            }
            catch (Exception e)
            {
            }
        }
    }

    private async Task ValidBrickLinkFormSubmitted()
    {
        var authenticationState = await State;
        var cp = authenticationState.User;

        if (cp.Identity is null || !cp.Identity.IsAuthenticated)
        {
            LastSubmitResultBL = "You must be logged in to sync.";
            isSuccesBL = false;
            return;
        }

        var uid = cp.FindFirst(ClaimTypes.NameIdentifier);
        if (uid == null || !int.TryParse(uid.Value, out int studUserId))
        {
            LastSubmitResultBL = "Error: Invalid user ID.";
            isSuccesBL = false;
            return;
        }

        _brickLinkCredentials.StudUserId = studUserId;
        LastSubmitResultBL = "Connecting BrickLink...";
        isSuccesBL = false;

        try
        {
            await StoreAuthClientService.SetBrickLinkCredentials(_brickLinkCredentials);
            LastSubmitResultBL = "Success! BrickLink connected.";
            isSuccesBL = true;
            IsBrickLinkConnected.IsConnected = true;
        }
        catch (Exception e)
        {
            LastSubmitResultBL = $"Server error: {e.Message}";
            isSuccesBL = false;
        }
    }

    private void InvalidBrickLinkFormSubmitted() => isSuccesBL = false;


    private async Task ValidBrickOwlFormSubmitted()
    {
        var authenticationState = await State;
        var cp = authenticationState.User;

        if (cp.Identity is null || !cp.Identity.IsAuthenticated)
        {
            LastSubmitResultBO = "You must be logged in to sync.";
            isSuccesBO = false;
            return;
        }

        var uid = cp.FindFirst(ClaimTypes.NameIdentifier);
        if (uid == null || !int.TryParse(uid.Value, out int studUserId))
        {
            LastSubmitResultBO = "Error: Invalid user ID.";
            isSuccesBO = false;
            return;
        }

        _brickOwlCredentials.StudUserId = studUserId;
        LastSubmitResultBO = "Connecting Brick Owl...";
        isSuccesBO = false;

        try
        {
            await StoreAuthClientService.SetBrickOwlCredentials(_brickOwlCredentials);
            LastSubmitResultBO = "Success! Brick Owl connected.";
            isSuccesBO = true;
            IsBrickOwlConnected.IsConnected = true;
        }
        catch (Exception e)
        {
            LastSubmitResultBO = $"Server error: {e.Message}";
            isSuccesBO = false;
        }
    }

    private void InvalidBrickOwlFormSubmitted() => isSuccesBO = false;


    private async Task ConfirmDisconnectBrickLink(bool confirmed)
    {
        if (confirmed)
        {
            await DisconnectBrickLink();
        }
        else
        {
            LastSubmitResultBL = "BrickLink disconnection cancelled.";
            isSuccesBL = false;
        }
    }

    private async Task DisconnectBrickLink()
    {
        var auth = await State;
        var cp = auth.User;

        var uid = cp.FindFirst(ClaimTypes.NameIdentifier);
        if (uid == null || !long.TryParse(uid.Value, out long studUserId))
        {
            LastSubmitResultBL = "Error: Invalid user ID.";
            isSuccesBL = false;
            return;
        }

        LastSubmitResultBL = "Disconnecting BrickLink...";
        try
        {
            await StoreAuthClientService.ClearBrickLinkCredentials(studUserId);
            LastSubmitResultBL = "BrickLink disconnected.";
            isSuccesBL = true;
            IsBrickLinkConnected.IsConnected = false;
            _brickLinkCredentials = new();
        }
        catch (Exception e)
        {
            LastSubmitResultBL = $"Error disconnecting: {e.Message}";
            isSuccesBL = false;
            StateHasChanged();
        }
    }

    private async Task ConfirmDisconnectBrickOwl(bool confirmed)
    {
        if (confirmed)
        {
            await DisconnectBrickOwl();
        }
        else
        {
            LastSubmitResultBO = "Brick Owl disconnection cancelled.";
            isSuccesBO = false;
        }
    }

    private async Task DisconnectBrickOwl()
    {
        var auth = await State;
        var cp = auth.User;

        var uid = cp.FindFirst(ClaimTypes.NameIdentifier);
        if (uid == null || !long.TryParse(uid.Value, out long studUserId))
        {
            LastSubmitResultBO = "Error: Invalid user ID.";
            isSuccesBO = false;
            return;
        }

        LastSubmitResultBO = "Disconnecting Brick Owl...";
        try
        {
            await StoreAuthClientService.ClearBrickOwlCredentials(studUserId);
            LastSubmitResultBO = "Brick Owl disconnected.";
            isSuccesBO = true;
            IsBrickOwlConnected.IsConnected = false;
            _brickOwlCredentials = new();
        }
        catch (Exception e)
        {
            LastSubmitResultBO = $"Error disconnecting: {e.Message}";
            isSuccesBO = false;
            StateHasChanged();
        }
    }

// TODO Fejl: Når man reloader page når data-serveren er slukket, vises Form (da e.g. IsBrickLinkConnected = false). Lave så der vises besked om data-server er nede i stedet for.
}
