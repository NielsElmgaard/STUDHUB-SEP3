@page "/StoreConnectionPage"
@using System.Security.Claims
@using Client.Components.ConnectionForms
@using Client.Services.StoreConnection
@using Microsoft.AspNetCore.Components.Authorization
@using Studhub.AppServer.Services.Auth_Login
@using StudHub.SharedDTO
@using StudHub.SharedDTO.StoreCredentials

@inject AuthenticationStateProvider AuthStateProvider
@inject IStoreAuthClientService StoreAuthClientService

<PageTitle>Store Connection</PageTitle>

<AuthorizeView>
    <Authorized>
        <!-- SAME HEADER STYLE AS DASHBOARD -->
        <div class="dashboard-header">
            <div class="dashboard-header-left">
                <h3 class="mb-1 page-title-glow">store connection</h3>
                <small class="logged-in-info">logged in as @userEmail</small>
            </div>
            <div class="dashboard-header-right">
                <!-- reserved for future notifications / status -->
            </div>
        </div>

        <div class="store-page">
            <!-- BrickLink section -->
            <section class="store-section">
                <h4 class="store-connection-glow mb-2">BrickLink</h4>

                <p class="store-body-text">
                    Steps to obtain BrickLink credentials:
                </p>
                <ul class="store-body-list">
                    <li>
                        Visit
                        <a href="https://www.bricklink.com/v2/api/register_consumer.page"
                           target="_blank" rel="noopener noreferrer">
                            BrickLink
                        </a>
                    </li>
                    <li>Add access token</li>
                    <li>We advise adding 0.0.0.0 for the IP Address and the IP Mask</li>
                </ul>

                @if (!string.IsNullOrEmpty(LastSubmitResultBL))
                {
                    <div class="alert @(isSuccesBL ? "alert-success" : "alert-danger") store-alert">
                        @LastSubmitResultBL
                    </div>
                }

                <BrickLinkCredentialsForm BrickLinkCredentials="_brickLinkCredentials"
                                          OnValidSubmit="ValidBrickLinkFormSubmitted"
                                          OnInvalidSubmit="InvalidBrickLinkFormSubmitted" />
            </section>

            <!-- BrickOwl section -->
            <section class="store-section mt-5">
                <h4 class="store-connection-glow mb-2">BrickOwl</h4>

                <p class="store-body-text">
                    Steps to obtain BrickOwl credentials:
                </p>
                <ul class="store-body-list">
                    <li>
                        Visit
                        <a href="https://www.brickowl.com/api_docs"
                           target="_blank" rel="noopener noreferrer">
                            Brick Owl
                        </a>
                    </li>
                    <li>Click the “generate an API key” link</li>
                    <li>Click the “Add API Key” button</li>
                    <li>Make sure the key is enabled</li>
                </ul>

                @if (!string.IsNullOrEmpty(LastSubmitResultBO))
                {
                    <div class="alert @(isSuccesBO ? "alert-success" : "alert-danger") store-alert">
                        @LastSubmitResultBO
                    </div>
                }

                <BrickOwlCredentialsForm BrickOwlCredentials="_brickOwlCredentials"
                                         OnValidSubmit="ValidBrickOwlFormSubmitted"
                                         OnInvalidSubmit="InvalidBrickOwlFormSubmitted" />
            </section>
        </div>
    </Authorized>

    <NotAuthorized>
        <NotAuthorizedContent />
    </NotAuthorized>
</AuthorizeView>

@code {
    private BrickLinkCredentialsRequestDTO _brickLinkCredentials = new();
    private BrickOwlCredentialsRequestDTO _brickOwlCredentials = new();

    private string? LastSubmitResultBL;
    private string? LastSubmitResultBO;
    private bool isSuccesBL;
    private bool isSuccesBO;

    private BrickLinkCredentialsResponseDTO? CreatedBrickLinkConnection;
    private BrickOwlCredentialsResponseDTO? CreatedBrickOwlConnection;

    [CascadingParameter] public Task<AuthenticationState> State { get; set; } = default!;

    private string? userEmail;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated ?? false)
        {
            userEmail = user.Identity.Name;
        }
    }

    private async Task ValidBrickLinkFormSubmitted()
    {
        var authenticationState = await State;
        var claimsPrincipal = authenticationState.User;

        if (claimsPrincipal.Identity is null || !claimsPrincipal.Identity.IsAuthenticated)
        {
            LastSubmitResultBL = "You must be logged in to sync.";
            isSuccesBL = false;
            return;
        }

        var userIdClaim = claimsPrincipal.FindFirst(ClaimTypes.NameIdentifier);
        if (userIdClaim == null || !long.TryParse(userIdClaim.Value, out long studUserId))
        {
            LastSubmitResultBL = "Error: Could not retrieve or parse user ID.";
            isSuccesBL = false;
            return;
        }

        _brickLinkCredentials.StudUserId = studUserId;
        LastSubmitResultBL = "Connecting BrickLink...";
        isSuccesBL = false;

        try
        {
            CreatedBrickLinkConnection =
                await StoreAuthClientService.SetBrickLinkCredentials(_brickLinkCredentials);

            LastSubmitResultBL = "Success! BrickLink connected.";
            isSuccesBL = true;
        }
        catch (Exception e)
        {
            LastSubmitResultBL = $"Server Error: {e.Message}";
            isSuccesBL = false;
        }
    }

    private void InvalidBrickLinkFormSubmitted()
    {
        isSuccesBL = false;
    }

    private async Task ValidBrickOwlFormSubmitted()
    {
        var authenticationState = await State;
        var claimsPrincipal = authenticationState.User;

        if (claimsPrincipal.Identity is null || !claimsPrincipal.Identity.IsAuthenticated)
        {
            LastSubmitResultBO = "You must be logged in to sync.";
            isSuccesBO = false;
            return;
        }

        var userIdClaim = claimsPrincipal.FindFirst(ClaimTypes.NameIdentifier);
        if (userIdClaim == null || !long.TryParse(userIdClaim.Value, out long studUserId))
        {
            LastSubmitResultBO = "Error: Could not retrieve or parse user ID.";
            isSuccesBO = false;
            return;
        }

        _brickOwlCredentials.StudUserId = studUserId;
        LastSubmitResultBO = "Connecting Brick Owl...";
        isSuccesBO = false;

        try
        {
            CreatedBrickOwlConnection =
                await StoreAuthClientService.SetBrickOwlCredentials(_brickOwlCredentials);

            LastSubmitResultBO = "Success! Brick Owl connected.";
            isSuccesBO = true;
        }
        catch (Exception e)
        {
            LastSubmitResultBO = $"Server Error: {e.Message}";
            isSuccesBO = false;
        }
    }

    private void InvalidBrickOwlFormSubmitted()
    {
        isSuccesBO = false;
    }
}
